<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{padding:20px}
    .card{border-radius:10px}
  </style>
</head>

<body class="container">
  <h1 class="mb-3">Admin Dashboard</h1>

  <div class="row">
    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <h5>Filters</h5>

        <label>Status</label>
        <select id="f_status" class="form-select mb-2">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="success">Success</option>
          <option value="failed">Failed</option>
        </select>

        <label>From</label>
        <input id="f_from" type="date" class="form-control mb-2">

        <label>To</label>
        <input id="f_to" type="date" class="form-control mb-2">

        <button class="btn btn-primary w-100 mb-2" onclick="applyFilters()">Apply</button>
        <button class="btn btn-outline-secondary w-100" onclick="exportCSV()">Export CSV</button>
      </div>

      <div class="card p-3">
        <h5>Stats</h5>
        <pre id="stats">Loading...</pre>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card p-3 mb-3">
        <h5>Donations Chart</h5>
        <canvas id="donChart" height="120"></canvas>
      </div>

      <div class="card p-3">
        <h5>Donations Table</h5>
        <table class="table table-sm" id="donTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const API = 'http://localhost:4000';

/* ---------------- AUTH ---------------- */

function getToken(){
  return localStorage.getItem("token");
}

function authHeaders(){
  const token = getToken();
  if(!token){
    alert("Admin token missing. Please login again.");
    throw new Error("Token missing");
  }
  return {
    "Content-Type": "application/json",
    "Authorization": "Bearer " + token
  };
}

/* ---------------- LOAD STATS ---------------- */

async function loadStats(){
  try{
    const res = await fetch(API + '/admin/stats', {
      headers: authHeaders()
    });

    if(!res.ok){
      alert("Unauthorized or backend error while loading stats.");
      return;
    }

    const data = await res.json();
    document.getElementById('stats').innerText =
      JSON.stringify(data, null, 2);

    const chartData = Array.isArray(data.byStatus) && data.byStatus.length
      ? data.byStatus
      : [{ status:"No Data", c:1 }];

    drawChart(chartData);
  }
  catch(err){
    console.error(err);
  }
}

/* ---------------- CHART ---------------- */

function drawChart(byStatus){
  const labels = byStatus.map(x => x.status);
  const values = byStatus.map(x => x.c);
  const ctx = document.getElementById('donChart').getContext('2d');

  if(window._don) window._don.destroy();

  window._don = new Chart(ctx, {
    type:'pie',
    data:{
      labels,
      datasets:[{ data: values }]
    }
  });
}

/* ---------------- FILTER DONATIONS ---------------- */

async function applyFilters(){
  try{
    const status = document.getElementById('f_status').value;
    const from   = document.getElementById('f_from').value;
    const to     = document.getElementById('f_to').value;

    const qs = new URLSearchParams();
    if(status) qs.set('status', status);
    if(from)   qs.set('from', from);
    if(to)     qs.set('to', to);

    const res = await fetch(
      API + '/admin/donations?' + qs.toString(),
      { headers: authHeaders() }
    );

    if(!res.ok){
      alert("Unauthorized or failed to load donations");
      return;
    }

    const arr = await res.json();
    if(!Array.isArray(arr)){
      console.error("Invalid donations response:", arr);
      return;
    }

    const tbody = document.querySelector('#donTable tbody');
    tbody.innerHTML = '';

    if(arr.length === 0){
      tbody.innerHTML = `<tr><td colspan="4" class="text-center">No records</td></tr>`;
    }

    arr.forEach(d=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.id}</td>
        <td>â‚¹${(d.amount_cents/100).toFixed(2)}</td>
        <td>${d.status}</td>
        <td>${new Date(d.created_at).toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });

    // Refresh stats when filters applied
    await loadStats();
  }
  catch(err){
    console.error(err);
  }
}

/* ---------------- EXPORT CSV ---------------- */

async function exportCSV(){
  try{
    const resp = await fetch(API + '/admin/registrations/export', {
      headers: authHeaders()
    });

    if(!resp.ok){
      alert("Export failed or unauthorized");
      return;
    }

    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'registrations.csv';
    document.body.appendChild(link);
    link.click();
    link.remove();
  }
  catch(err){
    console.error(err);
  }
}

/* ---------------- INIT ---------------- */

(async function init(){
  try{
    const token = getToken();
    if(!token){
      alert("Please login as ADMIN and store token in localStorage.token");
      return;
    }

    await loadStats();
    await applyFilters();
  }
  catch(err){
    console.error(err);
  }
})();
</script>

</body>
</html>
